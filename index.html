<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <title>Gesti√≥n de Invitados</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>

<body class="bg-light">
  <div class="container py-5">
    <h1 class="text-center mb-4">Gesti√≥n de Invitados</h1>

    <!-- Bot√≥n para abrir modal -->
    <div class="text-end mb-3">
      <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modalInvitado">
        ‚ûï Agregar Invitado
      </button>
    </div>

    <!-- Contenedor de mesas  -->
    <div id="mesasContainer"></div>
  </div>

  <!-- Modal Bootstrap -->
  <div class="modal fade" id="modalInvitado" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <form id="formInvitado">
          <div class="modal-header">
            <h5 class="modal-title" id="modalTitle">Agregar Invitado</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
          </div>
          <div class="modal-body">
            <input type="hidden" id="Id"> <!-- usado para edici√≥n -->

            <div class="mb-3">
              <label class="form-label">Nombre</label>
              <input type="text" class="form-control" id="Nombre" required>
            </div>
            <div class="mb-3">
              <label class="form-label">Cantidad</label>
              <input type="number" class="form-control" id="Cantidad" required>
            </div>
            <div class="mb-3">
              <label class="form-label">Tel√©fono</label>
              <input type="number" class="form-control" id="Telefono" required>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
            <button type="submit" class="btn btn-primary">Guardar</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <!-- L√≥gica con Netlify Functions -->
  <script>
    const mesasContainer = document.getElementById("mesasContainer");
    const form = document.getElementById("formInvitado");
    const modalEl = document.getElementById("modalInvitado");
    const modal = new bootstrap.Modal(modalEl);

    // üîπ Funciones helper para llamar serverless
    async function llamarFuncion(nombre, metodo = "GET", data = null) {
      const options = { method: metodo };
      if (data) {
        options.headers = { "Content-Type": "application/json" };
        options.body = JSON.stringify(data);
      }
      const res = await fetch(`/.netlify/functions/${nombre}`, options);
      return await res.json();
    }

    async function generarIdInvitado() {
      const r = await llamarFuncion("generarIdInvitado");
      return r.id;
    }

    async function cargarInvitados() {
      mesasContainer.innerHTML = "";
      const invitados = await llamarFuncion("cargarInvitados");
      const mesas = {};

      invitados.forEach(inv => {
        const mesa = inv.Mesa || 0;
        if (!mesas[mesa]) mesas[mesa] = [];
        mesas[mesa].push(inv);
      });

      Object.keys(mesas).forEach(mesaNum => {
        const card = document.createElement("div");
        card.className = "card mb-4";

        let rows = "";
        mesas[mesaNum].forEach(inv => {
          rows += `
            <tr>
              <td>${inv.id}</td>
              <td>${inv.Nombre}</td>
              <td>${inv.Cantidad}</td>
              <td>
                <select class="form-select form-select-sm" id="mesa-${inv.id}">
                  ${[...Array(12).keys()].map(i =>
              `<option value="${i + 1}" ${inv.Mesa === (i + 1) ? "selected" : ""}>${i + 1}</option>`
            ).join("")}
                </select>
              </td>
              <td>${inv.Telefono}</td>
              <td>
                <button class="btn btn-sm btn-success me-1" onclick="guardarMesa('${inv.id}')">üíæ</button>
                <button class="btn btn-sm btn-warning me-1" onclick="editarInvitado('${inv.id}')">‚úèÔ∏è</button>
                <button class="btn btn-sm btn-danger" onclick="eliminarInvitado('${inv.id}')">üóëÔ∏è</button>
              </td>
            </tr>
          `;
        });

        card.innerHTML = `
          <div class="card-header">Mesa ${mesaNum}</div>
          <div class="card-body p-0">
            <table class="table table-striped table-bordered m-0">
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Nombre</th>
                  <th>Cantidad</th>
                  <th>Mesa</th>
                  <th>Tel√©fono</th>
                  <th>Acciones</th>
                </tr>
              </thead>
              <tbody>${rows}</tbody>
            </table>
          </div>
        `;
        mesasContainer.appendChild(card);
      });
    }

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      let Id = document.getElementById("Id").value;

      if (!Id) {
        Id = await generarIdInvitado();
      }

      const data = {
        Nombre: document.getElementById("Nombre").value,
        Cantidad: parseInt(document.getElementById("Cantidad").value),
        Telefono: parseInt(document.getElementById("Telefono").value),
        Mesa: 1
      };

      await llamarFuncion("guardarInvitado", "POST", { id: Id, data });
      form.reset();
      document.getElementById("Id").value = "";
      modal.hide();
      cargarInvitados();
    });

    window.editarInvitado = async (id) => {
      const data = await llamarFuncion("editarInvitado", "POST", { id });
      document.getElementById("Id").value = id;
      document.getElementById("Nombre").value = data.Nombre;
      document.getElementById("Cantidad").value = data.Cantidad;
      document.getElementById("Telefono").value = data.Telefono;
      document.getElementById("modalTitle").textContent = "Editar Invitado";
      modal.show();
    };

    window.eliminarInvitado = async (id) => {
      if (confirm("¬øSeguro que deseas eliminar este invitado?")) {
        await llamarFuncion("eliminarInvitado", "POST", { id });
        cargarInvitados();
      }
    };

    window.guardarMesa = async (id) => {
      const select = document.getElementById(`mesa-${id}`);
      const nuevaMesa = parseInt(select.value);
      await llamarFuncion("guardarMesa", "POST", { id, mesa: nuevaMesa });
      alert("Mesa actualizada ‚úÖ");
      cargarInvitados();
    };

    // Inicial
    cargarInvitados();
  </script>
</body>

</html>
