<script type="module">
const mesasContainer = document.getElementById("mesasContainer");
const form = document.getElementById("formInvitado");
const modalEl = document.getElementById("modalInvitado");
const modal = new bootstrap.Modal(modalEl);

// 🔹 Helpers de consumo
async function apiGet() {
  const res = await fetch("/.netlify/functions/invitados");
  return res.json();
}

async function apiPost(action, payload) {
  const res = await fetch("/.netlify/functions/invitados", {
    method: "POST",
    body: JSON.stringify({ action, ...payload })
  });
  return res.json();
}

// 🔹 Cargar lista agrupada por mesas
async function cargarInvitados() {
  mesasContainer.innerHTML = "";
  const lista = await apiGet();

  const mesas = {};
  lista.forEach(inv => {
    const mesa = inv.Mesa || 0;
    if (!mesas[mesa]) mesas[mesa] = [];
    mesas[mesa].push(inv);
  });

  Object.keys(mesas).forEach(mesaNum => {
    const card = document.createElement("div");
    card.className = "card mb-4";
    let rows = "";
    mesas[mesaNum].forEach(inv => {
      rows += `
        <tr>
          <td>${inv.id}</td>
          <td>${inv.Nombre}</td>
          <td>${inv.Cantidad}</td>
          <td>
            <select class="form-select form-select-sm" id="mesa-${inv.id}">
              ${[...Array(12).keys()].map(i =>
                `<option value="${i + 1}" ${inv.Mesa === (i + 1) ? "selected" : ""}>${i + 1}</option>`
              ).join("")}
            </select>
          </td>
          <td>${inv.Telefono}</td>
          <td>
            <button class="btn btn-sm btn-success me-1" onclick="guardarMesa('${inv.id}')">💾</button>
            <button class="btn btn-sm btn-warning me-1" onclick="editarInvitado('${inv.id}')">✏️</button>
            <button class="btn btn-sm btn-danger" onclick="eliminarInvitado('${inv.id}')">🗑️</button>
          </td>
        </tr>
      `;
    });

    card.innerHTML = `
      <div class="card-header">Mesa ${mesaNum}</div>
      <div class="card-body p-0">
        <table class="table table-striped table-bordered m-0">
          <thead>
            <tr>
              <th>ID</th>
              <th>Nombre</th>
              <th>Cantidad</th>
              <th>Mesa</th>
              <th>Teléfono</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody>${rows}</tbody>
        </table>
      </div>
    `;
    mesasContainer.appendChild(card);
  });
}

// 🔹 Guardar o actualizar
form.addEventListener("submit", async (e) => {
  e.preventDefault();
  let Id = document.getElementById("Id").value;

  const data = {
    Id,
    Nombre: document.getElementById("Nombre").value,
    Cantidad: parseInt(document.getElementById("Cantidad").value),
    Telefono: parseInt(document.getElementById("Telefono").value),
    Mesa: 1
  };

  await apiPost("guardar", { data });
  form.reset();
  document.getElementById("Id").value = "";
  modal.hide();
  cargarInvitados();
});

// 🔹 Editar
window.editarInvitado = async (id) => {
  const res = await apiPost("obtener", { id });
  if (res) {
    document.getElementById("Id").value = res.id;
    document.getElementById("Nombre").value = res.Nombre;
    document.getElementById("Cantidad").value = res.Cantidad;
    document.getElementById("Telefono").value = res.Telefono;
    document.getElementById("modalTitle").textContent = "Editar Invitado";
    modal.show();
  }
};

// 🔹 Eliminar
window.eliminarInvitado = async (id) => {
  if (confirm("¿Seguro que deseas eliminar este invitado?")) {
    await apiPost("eliminar", { id });
    cargarInvitados();
  }
};

// 🔹 Guardar cambio de mesa
window.guardarMesa = async (id) => {
  const select = document.getElementById(`mesa-${id}`);
  const nuevaMesa = parseInt(select.value);
  await apiPost("mesa", { id, mesa: nuevaMesa });
  alert("Mesa actualizada ✅");
  cargarInvitados();
};

// Inicial
cargarInvitados();
</script>
