<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <title>Gesti√≥n de Invitados</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>

<body class="bg-light">
    <div class="container py-5">
        <h1 class="text-center mb-4">Gesti√≥n de Invitados</h1>

        <!-- Bot√≥n para abrir modal -->
        <div class="text-end mb-3">
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modalInvitado">
                ‚ûï Agregar Invitado
            </button>
        </div>

        <!-- Contenedor de mesas -->
        <div id="mesasContainer"></div>
    </div>

    <!-- Modal Bootstrap -->
    <div class="modal fade" id="modalInvitado" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <form id="formInvitado">
                    <div class="modal-header">
                        <h5 class="modal-title" id="modalTitle">Agregar Invitado</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                    </div>
                    <div class="modal-body">
                        <input type="hidden" id="Id"> <!-- usado para edici√≥n -->

                        <div class="mb-3">
                            <label class="form-label">Nombre</label>
                            <input type="text" class="form-control" id="Nombre" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Cantidad</label>
                            <input type="number" class="form-control" id="Cantidad" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Tel√©fono</label>
                            <input type="number" class="form-control" id="Telefono" required>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-primary">Guardar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Firebase + JS -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
        import {
            getFirestore, collection, getDocs, doc, setDoc, deleteDoc, getDoc, updateDoc,
            query, orderBy
        } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";

        // üîπ Configuraci√≥n Firebase (reemplazar con la tuya)
        const firebaseConfig = {
            apiKey: "AIzaSyC6Di7CyehlsNI08PGpBHU75VJhVMWxEJs",
            authDomain: "invitadosboda-e1314.firebaseapp.com",
            projectId: "invitadosboda-e1314",
            storageBucket: "invitadosboda-e1314.firebasestorage.app",
            messagingSenderId: "159250168397",
            appId: "1:159250168397:web:aa693cd4472ba0bf2f3a04",
            measurementId: "G-6Y772NVW4S"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        const mesasContainer = document.getElementById("mesasContainer");
        const form = document.getElementById("formInvitado");
        const modalEl = document.getElementById("modalInvitado");
        const modal = new bootstrap.Modal(modalEl);

        // üîπ Generar ID rellenando huecos
        async function generarIdInvitado() {
            const letras = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
            let randomLetras = "";
            for (let i = 0; i < 3; i++) {
                randomLetras += letras.charAt(Math.floor(Math.random() * letras.length));
            }

            const snapshot = await getDocs(collection(db, "Invitados"));
            let numeros = [];
            snapshot.forEach(docSnap => {
                const partes = docSnap.id.split("-");
                if (partes.length === 3) {
                    const numero = parseInt(partes[2], 10);
                    if (!isNaN(numero)) numeros.push(numero);
                }
            });

            numeros.sort((a, b) => a - b);
            let secuencia = 1;
            for (let i = 0; i < numeros.length; i++) {
                if (numeros[i] !== secuencia) break;
                secuencia++;
            }

            const numeroFormateado = String(secuencia).padStart(3, "0");
            return `INV-${randomLetras}-${numeroFormateado}`;
        }

        // üîπ Cargar lista agrupada por mesas
        async function cargarInvitados() {
            mesasContainer.innerHTML = "";

            const invitadosQuery = query(collection(db, "Invitados"), orderBy("Mesa", "asc"));
            const querySnapshot = await getDocs(invitadosQuery);

            const mesas = {};
            querySnapshot.forEach(docSnap => {
                const data = docSnap.data();
                const mesa = data.Mesa || 0;
                if (!mesas[mesa]) mesas[mesa] = [];
                mesas[mesa].push({ id: docSnap.id, ...data });
            });

            Object.keys(mesas).forEach(mesaNum => {
                const card = document.createElement("div");
                card.className = "card mb-4";

                let rows = "";
                mesas[mesaNum].forEach(inv => {
                    rows += `
            <tr>
            <td>${inv.id}</td>
              <td>${inv.Nombre}</td>
              <td>${inv.Cantidad}</td>
              <td>
                <select class="form-select form-select-sm" id="mesa-${inv.id}">
                  ${[...Array(12).keys()].map(i =>
                        `<option value="${i + 1}" ${inv.Mesa === (i + 1) ? "selected" : ""}>${i + 1}</option>`
                    ).join("")}
                </select>
              </td>
              <td>${inv.Telefono}</td>
              <td>
                <button class="btn btn-sm btn-success me-1" onclick="guardarMesa('${inv.id}')">üíæ</button>
                <button class="btn btn-sm btn-warning me-1" onclick="editarInvitado('${inv.id}')">‚úèÔ∏è</button>
                <button class="btn btn-sm btn-danger" onclick="eliminarInvitado('${inv.id}')">üóëÔ∏è</button>
              </td>
            </tr>
          `;
                });

                card.innerHTML = `
          <div class="card-header">Mesa ${mesaNum}</div>
          <div class="card-body p-0">
            <table class="table table-striped table-bordered m-0">
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Nombre</th>
                  <th>Cantidad</th>
                  <th>Mesa</th>
                  <th>Tel√©fono</th>
                  <th>Acciones</th>
                </tr>
              </thead>
              <tbody>${rows}</tbody>
            </table>
          </div>
        `;
                mesasContainer.appendChild(card);
            });
        }

        // üîπ Guardar o actualizar desde modal
        form.addEventListener("submit", async (e) => {
            e.preventDefault();
            let Id = document.getElementById("Id").value;

            if (!Id) {
                Id = await generarIdInvitado(); // nuevo
            }

            const data = {
                Nombre: document.getElementById("Nombre").value,
                Cantidad: parseInt(document.getElementById("Cantidad").value),
                Telefono: parseInt(document.getElementById("Telefono").value),
                Mesa: 1 // default para nuevos (luego se puede mover con el select)
            };

            await setDoc(doc(db, "Invitados", Id), data);
            form.reset();
            document.getElementById("Id").value = "";
            modal.hide();
            cargarInvitados();
        });

        // üîπ Editar
        window.editarInvitado = async (id) => {
            const docRef = doc(db, "Invitados", id);
            const docSnap = await getDoc(docRef);
            if (docSnap.exists()) {
                const data = docSnap.data();
                document.getElementById("Id").value = id;
                document.getElementById("Nombre").value = data.Nombre;
                document.getElementById("Cantidad").value = data.Cantidad;
                document.getElementById("Telefono").value = data.Telefono;
                document.getElementById("modalTitle").textContent = "Editar Invitado";
                modal.show();
            }
        };

        // üîπ Eliminar
        window.eliminarInvitado = async (id) => {
            if (confirm("¬øSeguro que deseas eliminar este invitado?")) {
                await deleteDoc(doc(db, "Invitados", id));
                cargarInvitados();
            }
        };

        // üîπ Guardar cambio de mesa
        window.guardarMesa = async (id) => {
            const select = document.getElementById(`mesa-${id}`);
            const nuevaMesa = parseInt(select.value);
            await updateDoc(doc(db, "Invitados", id), { Mesa: nuevaMesa });
            alert("Mesa actualizada ‚úÖ");
            cargarInvitados();
        };

        // Inicial
        cargarInvitados();
    </script>
</body>

</html>