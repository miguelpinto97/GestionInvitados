<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <title>Gesti√≥n de Invitados</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>

<body class="bg-light">
    <div class="container py-5">
        <h1 class="text-center mb-4">Gesti√≥n de Invitados</h1>

        <!-- Formulario -->
        <div class="card mb-4">
            <div class="card-header">Agregar / Editar Invitado</div>
            <div class="card-body">
                <form id="formInvitado">
                    <input type="hidden" id="Id"> <!-- usado para edici√≥n -->

                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">Nombre</label>
                            <input type="text" class="form-control" id="Nombre" required>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Cantidad</label>
                            <input type="number" class="form-control" id="Cantidad" required>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Mesa</label>
                            <input type="number" class="form-control" id="Mesa" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Tel√©fono</label>
                            <input type="text" class="form-control" id="Telefono" required>
                        </div>
                    </div>

                    <div class="mt-3">
                        <button type="submit" class="btn btn-primary">Guardar</button>
                        <button type="reset" class="btn btn-secondary" id="btnCancelar">Cancelar</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Tabla -->
        <div class="card">
            <div class="card-header">Lista de Invitados</div>
            <div class="card-body">
                <table class="table table-bordered table-striped">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Nombre</th>
                            <th>Cantidad</th>
                            <th>Mesa</th>
                            <th>Tel√©fono</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="tablaInvitados"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Firebase + JS -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
        import {
            getFirestore, collection, getDocs, doc, setDoc, deleteDoc, getDoc,
            query, orderBy
        } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";

        // üîπ Reemplaza con tu configuraci√≥n Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyC6Di7CyehlsNI08PGpBHU75VJhVMWxEJs",
            authDomain: "invitadosboda-e1314.firebaseapp.com",
            projectId: "invitadosboda-e1314",
            storageBucket: "invitadosboda-e1314.firebasestorage.app",
            messagingSenderId: "159250168397",
            appId: "1:159250168397:web:aa693cd4472ba0bf2f3a04",
            measurementId: "G-6Y772NVW4S"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        const form = document.getElementById("formInvitado");
        const tabla = document.getElementById("tablaInvitados");
        const btnCancelar = document.getElementById("btnCancelar");

        // Funci√≥n para generar ID en el formato INV-ABC-001
        async function generarIdInvitado() {
            const letras = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
            let randomLetras = "";
            for (let i = 0; i < 3; i++) {
                randomLetras += letras.charAt(Math.floor(Math.random() * letras.length));
            }

            // Contar documentos existentes para la parte secuencial
            const snapshot = await getDocs(collection(db, "Invitados"));
            const count = snapshot.size + 1; // siguiente n√∫mero
            const secuencia = String(count).padStart(3, "0");

            return `INV-${randomLetras}-${secuencia}`;
        }

        // Cargar lista (ordenada por Mesa)
        async function cargarInvitados() {
            tabla.innerHTML = "";

            const invitadosQuery = query(collection(db, "Invitados"), orderBy("Mesa", "asc"));
            const querySnapshot = await getDocs(invitadosQuery);

            querySnapshot.forEach(docSnap => {
                const data = docSnap.data();
                const row = document.createElement("tr");

                row.innerHTML = `
          <td>${docSnap.id}</td>
          <td>${data.Nombre}</td>
          <td>${data.Cantidad}</td>
          <td>${data.Mesa}</td>
          <td>${data.Telefono}</td>
          <td>
            <button class="btn btn-sm btn-warning me-2" onclick="editarInvitado('${docSnap.id}')">‚úèÔ∏è</button>
            <button class="btn btn-sm btn-danger" onclick="eliminarInvitado('${docSnap.id}')">üóëÔ∏è</button>
          </td>
        `;

                tabla.appendChild(row);
            });
        }

        // Guardar o actualizar
        form.addEventListener("submit", async (e) => {
            e.preventDefault();
            let Id = document.getElementById("Id").value;

            if (!Id) {
                Id = await generarIdInvitado(); // nuevo invitado
            }

            const data = {
                Nombre: document.getElementById("Nombre").value,
                Cantidad: parseInt(document.getElementById("Cantidad").value),
                Mesa: parseInt(document.getElementById("Mesa").value),
                Telefono: document.getElementById("Telefono").value
            };

            await setDoc(doc(db, "Invitados", Id), data);
            form.reset();
            document.getElementById("Id").value = "";
            cargarInvitados();
        });

        // Editar
        window.editarInvitado = async (id) => {
            const docRef = doc(db, "Invitados", id);
            const docSnap = await getDoc(docRef);
            if (docSnap.exists()) {
                const data = docSnap.data();
                document.getElementById("Id").value = id;
                document.getElementById("Nombre").value = data.Nombre;
                document.getElementById("Cantidad").value = data.Cantidad;
                document.getElementById("Mesa").value = data.Mesa;
                document.getElementById("Telefono").value = data.Telefono;
            }
        };

        // Eliminar
        window.eliminarInvitado = async (id) => {
            if (confirm("¬øSeguro que deseas eliminar este invitado?")) {
                await deleteDoc(doc(db, "Invitados", id));
                cargarInvitados();
            }
        };

        // Cancelar edici√≥n
        btnCancelar.addEventListener("click", () => {
            form.reset();
            document.getElementById("Id").value = "";
        });

        // Inicial
        cargarInvitados();
    </script>
</body>

</html>